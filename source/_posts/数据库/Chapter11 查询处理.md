---
title: 第十一章 查询处理
date: 2021-6-17 00:00:00
tags: 
categories: 数据库
---
## 第十一章 查询处理

<!-- more -->

本章大部分内容cv自wht同学的笔记

### 11.1 查询处理概述

**|查询处理|**：包括语法分析、正确性验证、查询优化以及查询执行等活动。

**|查询优化|**：为查询处理选择一个高效的执行策略。通常采取的策略是寻找一种近似最优解。

#### 查询处理的四个主要阶段

- 分解
- 优化
- 代码生成
- 代码执行

<img src="https://i.loli.net/2021/06/18/4RMXLsxbjO6Tn1g.png" alt="1.png" style="zoom:67%;" />

### 11.2 查询解析

**step 1 验证语法是否正确，若否，拒绝执行**

**step 2 创建查询树：**

- 为查询中的每一个基础关系创建一个叶子节点
- 为每个关系代数运算产生的中间关系创建一个非叶子节点
- 最终查询结构作为根节点，连接各个节点
- 这样就形成了关系代数查询树 relational algebra tree，语句的运算按照从叶到根的顺序执行

**step 3 规范化** 将表达式里的谓词（SQL中的WHERE子句）转换为以下两种范式之一：

- 合取范式 (a ∧ b) ∨ (c ∧ d) ∨ …
- 析取范式 (a ∨ b) ∧ (c ∨ d) ∧ …

**step 4 语义分析：**判断是否有自相矛盾的谓词，简化它们为True或False

**step 5 化简：**检测冗余条件，去除公共子表达式

### 11.3 查询优化

查询优化的目标：选择资源占用最少的等价查询形式，资源占用最少可以从**所有运算执行时间的总和**或**查询的响应时间**方面来量化。

### 11.4 关系代数运算的转换规则

1.  串联式规则，合取选择运算转换为单个选择的运算的串联
2.  交换选择运算的顺序
3.  投影运算的串联与只执行最后一个投影运算等价
4.  选择运算和投影运算的交换律（谓词相同的情况下）
5.  θ连接/笛卡尔积运算的交换律、结合律
6. 选择运算和θ连接/笛卡尔积运算的分配律
7.  投影运算和θ连接/笛卡尔积运算的分配律
8.  交运算和并运算的交换律、结合律
9. 选择运算和交/并/差运算的分配律
10.  投影运算和并运算的分配律

### 11.5 启发式(Heuristic)处理策略

1. 尽早执行选择运算和投影运算
2. 合并笛卡尔积运算和其后的选择运算为连接运算
3. 利用二元运算的结合律对叶子节点进行重排序，条件越严格的选择运算，越先执行
4. 如果有公共表达式在计算中多次出现，只执行一次其值的计算

### 11.6 关系代数运算的代价估计

前提：DBMS知道数据库的统计信息，即其中数据的规模
参数：R-关系，A-属性，I-索引
数据库的统计信息包含三类：（DBMS应周期性更新这些数据）

**基本关系统计信息**

- nTuples(R) ：关系R的元组数目（R的基数）
- bFactor(R) ：关系R的块因子blocking factor，即一块可以存储R中元组的个数
- nBlocks(R)：存储关系R需要的块数，即以上两个参数之商

**关系中的属性的统计信息**

- nDistinct(A,R)：属性A在关系R中不同取值的个数
- min(A,R)/max(A,R)：属性A在R中的可能最小值/最大值
- SC(A,R)：属性A在关系R中的选择基数selection cardinality，即满足属性A的某个等值条件的平均元组个数，这需要DBMS根据实际情况估算

**属性上多级索引的统计信息**

- nLevels(A,I)：I的索引级数
- nLfBlocks(A,I)：I中叶子的块数


通过这些数据，以及DBMS在各种关系运算操作中使用的算法，即可估算不同算法的运算代价的相对值

