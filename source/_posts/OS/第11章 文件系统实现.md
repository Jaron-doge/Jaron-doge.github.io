---
title: 第11章 文件系统实现
date: 2020-12-5 13:30:15
tags: 
categories: 操作系统
---
## 文件系统实现

### 11.1 文件系统结构

<!-- more -->

**分层文件系统**

![14.png](https://i.loli.net/2021/06/17/rslg7tjBNFiCbvn.png)

### 11.2 文件系统实现

#### 11.2.1概述

##### 在磁盘上

- **引导控制块(Boot control block)**：包含系统从该卷引导OS所需的信息

  - 如果为空，则磁盘不包含OS

- **卷控制块**：包含卷（或分区）的详细信息

- **目录结构**用于组织文件
- 每个文件的**FCB**包含该文件的许多详细信息

![15.png](https://i.loli.net/2021/06/17/WEJyu8fqKBCpoUs.png)

##### 在内存中

内存中的信息用于管理文件系统并通过缓存来提高性能，**这些数据在挂载文件系统时被加载，在卸载时被丢弃**

**结构类型**

- 每个进程的文件打开表

- 整个系统的文件打开表

- 内存中的挂载表
- 内存中的目录结构的缓存

**文件系统实现的操作结构**

![16.png](https://i.loli.net/2021/06/17/XMYJHfnkT79yVWp.png)

#### 11.2.2 分区与安装

- 引导信息通常是一系列连续的快，可作为映像加载到内存。

- 引导加载程序(boot loader)可以双重引导，允许具有多个FS和OS

- 根分区在启动时安装，其他卷可以在引导时自动安装或手动安装

#### 11.2.3 虚拟文件系统

- 虚拟文件系统（VFS，虚拟文件系统）提供了面向对象的文件系统实现方式

  VFS允许将相同的系统调用接口（API）用于不同类型的文件系统

- 该API是针对VFS接口的，而不是任何特定的文件系统的类型

![17.png](https://i.loli.net/2021/06/17/65NILXb2mZTqiQn.png)

### 11.3 目录实现

#### 11.3.1 线性序列

- 易于编程
- 执行耗时

#### 11.3.2 哈希表

- 减少目录搜索时间
- 产生冲突

### 11.4 分配方法

#### 11.4.1 连续分配

- 每个文件的目录条目包括起始块的地址和文件所分配区域的长度

![18.png](https://i.loli.net/2021/06/17/OsXf9QdTRlW2FiL.png)

**优点**

- 支持随机访问和顺序访问
- 磁头移动时间短(寻道时间短)，访问速度快

**缺点**

- 外部碎片
- 需要事先知道文件的大小⇒文件可能无法扩展

**解决方案：基于扩展的系统**

当空间不够时添加另一块连续空间(extent)，然后文件块的位置就记录为：地址、块数、下一扩展的首块的指针

#### 11.4.2 链接(Linked)分配

每个文件都是磁盘块上的链表，块可能分散在磁盘的任何位置

##### 隐式链接

目录包含文件第一块和最后一块的指针

每块都有下一块的一个指针

![19.png](https://i.loli.net/2021/06/17/kcXeFfhSzrGqACi.png)

**优点**

- 简单——只需要起始地址

- 不会浪费空间，没有外部碎片

**缺点**

- 不能随机访问

- 指针需要额外空间

**解决方案**

将多个块组成**簇(cluster)**，按**簇**分配

- 提高磁盘吞吐量（更少的磁头移动）
- 但是内部碎片增加：如果一个簇没有完全使用，会浪费更多空间

##### 显式链接

**文件分配表(File-Allocation Table, FAT)**

**通过将磁盘中的寻指针操作，替换成缓存过的FAT放入内存中，提高性能**

每个卷的开始部分的磁盘用于存储**FAT**

- **FAT**的使用与链表相同，目录条目包含文件首块的块号。通过这个块号索引的表条目包含文件的下一块的块号
- 未使用的块用0作为表条目的值来表示

![20.png](https://i.loli.net/2021/06/17/nVJdSH83hRmLxPv.png)

<img src="https://i.loli.net/2021/06/17/4WVjd2Tw8DfJ3iv.png" alt="21.png" style="zoom:50%;" />

#### 11.4.3 索引分配

将所有指针放在一起——索引块

- 每个文件都有自己的索引块
- 每个索引块都是一个磁盘块地址的数组

![22.png](https://i.loli.net/2021/06/17/QpYSZFN6tW9gxHM.png)

**优点**

- 随机访问

- 动态访问且无外部碎片

**缺点**

- 索引块的额外开销
- 文件大小的限制，索引块只能包含有限个数的指针

**解决方案**

1. 链接方式

   最后一个地址为null(对于小文件)，或者另一个索引块的指针(对于大文件)

2. 多级索引

![23.png](https://i.loli.net/2021/06/17/jQMPxa1eGy32KWp.png)

3. 组合方式

   将索引块的前几个指针指向**直接块**，接下来的几个指针指向**间接块**（一级、二级、三级逐级递增），这样的方式可以允许小文件直接访问

### 11.5 空闲空间管理

为了跟踪空闲磁盘空间，系统需要维护一个**空闲空间列表(free-space list)**

#### 11.5.1 位向量(bit vector)

空闲空间列表按**位图**或**位向量**来实现，每块用一个位来表示。1表示空闲，0表示已分配

如2，3，4，5，8, 9, 10, 11是空闲的，则位图为

0011 1100 1111

**位图长度**

对于n个块，如果基本单位是word，则位图长度=（n + 15）/ 16

**第一个空闲块**

1. 找到第一个非0字

2. 在第一个非0字中找到第一个1位

3. 前K个字为0，第一个1位的偏移为L

   N = K * 16 + L

**特性**

- 简单
- 必须保存在磁盘上
- 位图需要额外空间

  #### 11.5.2 链表

将所有空闲磁盘块用链表链接起来

- 将指向第一空闲块的指针保存在磁盘特殊位置上，并缓存在内存中
- 第一块包含下一个空闲磁盘块的指针

**特性**

- 无法轻易获得连续空间
- 不浪费空间

#### 11.5.3 计数

前提：通常，多个连续块可能需要同时分配获释放

- 空闲空间列表的每个条目记录第一块的地址和紧跟第一块的连续空闲块的数量n
- 通常情况下比链表短，counter > 1

### 11.6 效率与性能

#### 11.6.1 效率（空间）

磁盘空间的有效使用在很大程度上取决于磁盘分配和目录算法

**各种方法**

- 不同的簇大小
- 保存在文件目录条目内的数据类型
- 用与访问数据的指针大小：大指针允许更大的文件，但需要使用更多磁盘空间

#### 11.6.2 性能（时间）

- 磁盘缓存——在磁盘控制器上，一旦进入寻道，就从磁头所处的扇区开始将整个磁道读到磁盘缓存

- 缓冲区缓存(**buffer cache**)——假设其中的块会频繁访问
- 随后释放(**free-behind**)和预先读取(**read-ahead**)——一旦请求下一个页面，就从缓冲区删除一个页面；请求的页面和一些之后的页面可以一起读取并缓存

- 通过将一部分内存专用为虚拟磁盘或RAM磁盘来提高PC性能

### 11.7 恢复

#### 11.7.1 一致性检查

将目录结构中的数据与磁盘上的数据块进行比较，并尝试解决不一致问题

#### 11.7.2 备份和恢复

备份：将数据从磁盘备份到另一存储设备

恢复：从备份还原数据来恢复丢失的文件或磁盘

### 作业

12.2 What problems could occur if a system allowed a file system to be
mounted simultaneously at more than one location?

同一文件会有多个路径，删除一个路径下的文件的同时也会删除其他路径下的该文件。

12.3 Why must the bit map for file allocation be kept on mass storage, rather than in main memory?

这样在系统崩溃时，如果位图在主存中则可用空间列表会丢失，在大容量存储中则不会。

12.4 Consider a system that supports the strategies of contiguous, linked,
and indexed allocation. What criteria should be used in deciding which
strategy is best utilized for a particular file?

如果文件相对较小，则可以用连续的策略；如果文件相对较大，且为顺序访问，则可以用链接的策略；如果文件相对较大，且为随机访问，则可以用索引的策略

12.5 One problem with contiguous allocation is that the user must preallocate enough space for each file. If the file grows to be larger than the
space allocated for it, special actions must be taken. One solution to this
problem is to define a file structure consisting of an initial contiguous
area (of a specified size). If this area is filled, the operating system
automatically defines an overflow area that is linked to the initial
contiguous area. If the overflow area is filled, another overflow area
is allocated. Compare this implementation of a file with the standard
contiguous and linked implementations.

与标准的连续策略来说，这种方法开销更大，因为需要动态分配额外的空间。但与链接策略比较，这种方法开销更小，因为起初就分配好了一些固定的空间。

12.6 How do caches help improve performance? Why do systems not use
more or larger caches if they are so useful?

caches可以让不同速度的设备进行有效率的通信，它将传输速度更慢的设备中的数据缓存在更快的设备中。caches一般较为昂贵，caches的大小增加会增加系统成本。

12.7 Why is it advantageous to the user for an operating system to dynamically allocate its internal tables? What are the penalties to the operating system for doing so?

动态分配内部表在系统使用量增长时可以提供更大的灵活性，避免了用户的使用限制。但是这样的设计会使得内核的结构和代码更为复杂，也更容易出错。而且动态分配表比静态表开销更大。

12.9 Consider a file system that uses a modifed contiguous-allocation
scheme with support for extents. A file is a collection of extents, with
each extent corresponding to a contiguous set of blocks. A key issue in
such systems is the degree of variability in the size of the extents. What
are the advantages and disadvantages of the following schemes?
a. All extents are of the same size, and the size is predetermined.
b. Extents can be of any size and are allocated dynamically.
c. Extents can be of a few fixed sizes, and these sizes are predetermined.

a. 分配方案简单，一个位图或者空闲列表就能解决分配的问题，缺点是会有内部碎片和外部碎片。

b. 优点是没有内部碎片，缺点是分配方案较为复杂，而且可能会有外部碎片生成。

c. 保证了分配的灵活性和较为简单，与a相比内部碎片较少，与b相比外部碎片较少，缺点是仍有内部和外部碎片。

12.10 Contrast the performance of the three techniques for allocating disk
blocks (contiguous, linked, and indexed) for both sequential and
random file access.

连续分配：每个文件占用一组磁盘块，同时支持顺序访问和随机访问，访问速度较快。但是它不能处理内部碎片和外部碎片，同时也难以增加大小。

链接分配：每个文件是一个磁盘块链表，支持顺序访问，但不支持随机访问。这种分配方法没有外部碎片，因为访问要沿指针访问，所以访问速度不如连续分配快。

索引分配：每个文件有自己的索引块。支持随机访问，不支持顺序访问。这种分配方法没有外部碎片。

12.11 What are the advantages of the variant of linked allocation that uses a
FAT to chain together the blocks of a file?

如果需要访问存储在磁盘中的块的时候。我们可以不用再先访问磁盘块，然后一个一个遍历指针，而是可以通过将FAT放入内存中，通过在FAT中检索找到所需的块，再去磁盘中访问，大大提高了性能。

12.12 Consider a system where free space is kept in a free-space list.
a. Suppose that the pointer to the free-space list is lost. Can the
system reconstruct the free-space list? Explain your answer.

可以，可以执行垃圾收集来重建空闲列表。

b. Consider a file system similar to the one used by UNIX with
indexed allocation. How many disk I/O operations might be
required to read the contents of a small local file at /a/b/c?
Assume that none of the disk blocks is currently being cached.

一共4个I/O操作，读目录a、b、c，读c中的文件

c. Suggest a scheme to ensure that the pointer is never lost as a result
of memory failure.

将空闲空间列表的指针存放在磁盘上

12.14 Discuss how performance optimizations for file systems might result
in difficulties in maintaining the consistency of the systems in the event
of computer crashes.

可能出现的主要困难是数据和元数据的延迟更新。系统可以推迟更新，让将来更新相同的数据。但是，如果系统没有提交延迟更新请求就崩溃了，那么文件系统的一致性就会被破坏。

