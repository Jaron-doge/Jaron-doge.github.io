---
title: 第10章 存储管理
date: 2020-11-29 13:30:15
tags: 
categories: 操作系统
---

## 存储管理

### 10.1 文件概念

<!-- more -->

- 文件是记录在外存上的相关信息的命名组合

- 文件是逻辑外存的最小分配单元

#### 10.1.1 文件属性

文件的属性包括：名称、标识符、类型、位置、尺寸、保护、时间、日期和用户标识

**目录**

- 所有的文件信息保存在目录结构中，目录结构也保存在外存上
- 通常，目录条目由文件的名称及其唯一的标志符组成
- 根据标识符可定位其他文件属性

![1.png](https://i.loli.net/2021/06/17/K7mRNYafjDu9XMJ.png)

#### 10.1.2 文件操作

​	创建：分配空间 + 创建目录条目

​	写：写指针

​	读：读指针

​	重定位文件：搜索

​	删除：释放空间 + 删除目录条目

​	截断(Truncate): 文件重置为0， 释放空间，保留其他文件属性

##### 每个进程表(per-process table) & 整个系统表(system-wide table)

每个进程表：存放进程对文件的使用信息

整个系统表：存放与进程无关的文件的信息

![2.png](https://i.loli.net/2021/06/17/hJKXLFw2fde7vVj.png)

​	文件指针：上次读写位置，**每个进程都是唯一的**

​	文件打开计数：跟踪打开文件的进程个数，为0时删除条目

​	文件的磁盘位置：查找磁盘上的文件所需的信息保存在内存中

​	访问权限：每个进程采用访问模式打开文件

##### 打开文件锁

**共享锁**

类似于读者锁，多个进程可以并发获取它

**独占(Exclusive)锁**

类似于写者锁，一次只有一个进程可以获取这样的锁

###### 强制 & 建议

操作系统可以提供**强制**或**建议**文件锁定机制。如果锁是**强制性**的，则一旦进程获取独占锁，操作系统就阻止任何其他进程访问锁定的文件。如果锁是**建议性**的，则操作系统不会阻止其他进程的访问。

#### 10.1.3 文件类型

#### 10.1.4 文件结构

大多现代操作系统支持最小数量的文件结构

- Example: UNIX认为每个文件为8个字节序列

优点：

- 应用程序更灵活
- 简化OS

#### 10.1.5 内部文件结构

将**逻辑文件(记录)**放入**物理块**中

##### 打包(Packing)

- 打包 & 解包：文件系统会自动将字节打包以存入物理磁盘块，或从磁盘块中解包得到字节

- 有内部碎片出现

![3.png](https://i.loli.net/2021/06/17/ZzRuLnrITcY4N2d.png)

### 10.2 访问方法

#### 10.2.1 顺序访问

![4.png](https://i.loli.net/2021/06/17/HvYlOfDs78mTwiX.png)

#### 10.2.2 直接访问

磁盘允许对任何文件块的随机访问

通过**相对块号**进行索引

![5.png](https://i.loli.net/2021/06/17/i1som3LxfrWGOBC.png)

#### 10.2.3 索引访问方式

![7.png](https://i.loli.net/2021/06/17/7GKNVfpo3nh65Ea.png)

### 10.3 目录与磁盘的结构

#### 10.3.1 储存结构

**分区** = **文件** + **目录**

![8.png](https://i.loli.net/2021/06/17/tIDCVeJHjUTx9n2.png)

#### 10.3.2 目录概述

搜索、创建、删除文件、遍历目录、重命名文件、遍历文件系统

#### 10.3.3 单层目录

![9.png](https://i.loli.net/2021/06/17/JrKoAsHSZ3aLv4m.png)

- 搜索速度慢
- 多用户时出现**命名冲突**

#### 10.3.4 双层目录

用户文件目录(User File Directory, **UFD**)：每个条目拥有用户文件的信息

主文件目录(Master File Directory, **MFD**)：每个词条包含用户名和指向UFD的指针

![10.png](https://i.loli.net/2021/06/17/qOTzANPZj7kErlR.png)

- 可以为不同的用户使用相同文件名
- 搜索效率提升
- 分组能力

#### 10.3.5 树形目录

​		目录只不过是一个文件，但它是按特殊方式处理的。每个目录条目都有一位来将条目定义为文件(0)或子目录(1)

**当前目录**

包含进程当前感兴趣的大多数文件。当引用一个文件就搜索当前目录

![11.png](https://i.loli.net/2021/06/17/B6poQeu9OWzxkCZ.png)

- 搜索效率
- 分组能力
- 但阻止了文件和目录的共享

#### 10.3.6 无环图目录

允许目录共享子目录和文件，但不能出现循环

##### 链接(link)

文件的内容是真实文件的路径名

##### 复制目录条目

在两个共享目录中复制有关共享文件的所有信息，因此两个条目相同切相等

- 但是难以维护一致性，在修改文件时要维护一致性

##### 遍历问题

- 不同的名字，实际上是同一个文件
- 需要不止一次地遍历共享结构

##### 删除问题

- 只要有用户删除就删除—>空悬指针
- 保留文件，直到它的所有引用都被删除

#### 10.3.7 通用图目录

![12.png](https://i.loli.net/2021/06/17/FB9eYrLo6tjnSKW.png)

**遍历问题**和**删除问题**依旧存在，甚至更复杂

- 限制访问目录的数量
- 垃圾回收方案

**如何保证无环**

- 可以只允许链接到文件而不是子目录
- 每次添加新链接时，使用周期检测算法

### 10.4 文件系统安装/挂载(Mounting)

- 文件系统在用于系统的进程之前必须先安装

- 没有挂载的文件系统需要被挂载到挂载点

![13.png](https://i.loli.net/2021/06/17/Zrg8GO1FMod3k5D.png)

### 10.5 文件共享

#### 10.5.3 一致性语义

一致性语义指定多个用户如何同时访问共享文件

##### 10.5.3.1 UNIX语义

- 写入一个打开的文件，该打开文件对同一打开文件的其他用户立即可见
- 共享文件指针以允许多个用户同时读写会话语义

##### 10.5.3.2 会话语义

- 仅在关闭文件后开始的会话中可见

### 10.6 保护

#### 10.6.1 访问类型

读、写、执行、附加、删除、列表

#### 10.6.2 访问控制

**访问控制列表(Access-Control List, ACL)**

- 为每个文件和目录关联一个ACL，指定每个用户的名称及其允许的访问类型

- 存储在目录项中

**三类用户**

所有者权限：1 1 1 RWX

组权限：1 1 0 	RW

其他权限：0 0 1	X

### 作业

11.1 Some systems automatically delete all user files when a user logs off or
a job terminates, unless the user explicitly requests that they be kept.
Other systems keep all files unless the user explicitly deletes them.
Discuss the relative merits of each approach.



11.2 Why do some systems keep track of the type of a file, while others leave
it to the user and others simply do not implement multiple file types?
Which system is “better”?



11.3 Similarly, some systems support many types of structures for a file’s
data, while others simply support a stream of bytes. What are the
advantages and disadvantages of each approach?



11.4 Could you simulate a multilevel directory structure with a single-level
directory structure in which arbitrarily long names can be used? If your
answer is yes, explain how you can do so, and contrast this scheme with
the multilevel directory scheme. If your answer is no, explain what
prevents your simulation’s success. How would your answer change
if file names were limited to seven characters?



11.5 Explain the purpose of the open() and close() operations.



11.6 In some systems, a subdirectory can be read and written by an
authorized user, just as ordinary files can be.
a. Describe the protection problems that could arise.
b. Suggest a scheme for dealing with each of these protection
problems.



11.9 Consider a file system in which a file can be deleted and its disk space
reclaimed while links to that file still exist. What problems may occur if
a new file is created in the same storage area or with the same absolute
path name? How can these problems be avoided?



11.10 The open-file table is used to maintain information about files that are
currently open. Should the operating system maintain a separate table
for each user or maintain just one table that contains references to files
that are currently being accessed by all users? If the same file is being
accessed by two different programs or users, should there be separate
entries in the open-file table? Explain.



11.11 What are the advantages and disadvantages of providing mandatory
locks instead of advisory locks whose use is left to users’ discretion?



11.12 Provide examples of applications that typically access files according
to the following methods:
• Sequential
• Random



11.13 Some systems automatically open a file when it is referenced for the first
time and close the file when the job terminates. Discuss the advantages
and disadvantages of this scheme compared with the more traditional
one, where the user has to open and close the file explicitly.



11.14 If the operating system knew that a certain application was going
to access file data in a sequential manner, how could it exploit this
information to improve performance?



11.15 Give an example of an application that could benefit from operating system support for random access to indexed files.



11.17 Some systems provide file sharing by maintaining a single copy of a
file. Other systems maintain several copies, one for each of the users
sharing the file. Discuss the relative merits of each approach.